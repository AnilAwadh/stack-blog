---
layout: post
title: Added a Second Server
date: 2008-10-28 17:21:19.000000000 -04:00
categories:
- server
tags: []
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  _podPressPostSpecific: a:6:{s:15:"itunes:subtitle";s:15:"##PostExcerpt##";s:14:"itunes:summary";s:15:"##PostExcerpt##";s:15:"itunes:keywords";s:17:"##WordPressCats##";s:13:"itunes:author";s:10:"##Global##";s:15:"itunes:explicit";s:2:"No";s:12:"itunes:block";s:2:"No";}
author:
  login: admin
  email: jatwood@codinghorror.com
  display_name: Jeff Atwood
  first_name: Jeff
  last_name: Atwood

---
<p>
Based on traffic levels last week -- we're at and beyond <a href="http://blog.stackoverflow.com/2008/09/then-a-miracle-occurs-public-beta/">where we were at launch</a> -- I decided it was time to pursue adding a second server.</p>
<p>
The second stackoverflow.com server has <a href="http://blog.stackoverflow.com/2008/04/our-dedicated-server/">identical specifications to our first server</a>, that is:</p>
<ul>
<li>Windows Server 2008 x64
</li>
<li>Dual Quad-Core Xeon E5320 (1.8 GHz)
</li>
<li>4 GB RAM
</li>
<li>271GB SAS hard drive
</li>
</ul>
<p>
As I've mentioned before, one of the most obvious scaling strategies for us is to move the database to its own, private server. We were thinking about upgrading to SQL Server 2008, so this was also a logical time to do that.</p>
<p>
As of Sunday night, <b>stackoverflow.com is now a two-server system: web on one server, database on the other</b>. They are connected to each other through a dedicated crossover gigabit ethernet connection.</p>
<p>
I have to give massive credit to <a href="http://www.brentozar.com/">Brent Ozar</a> here, who not only helped us tune the database, but also contributed a <i>huge</i> chunk of his own time. Brent wrote a <a href="http://www.brentozar.com/archive/2008/10/sql-2008-upgrade-tuning-for-stackoverflowcom/">blog post about his experience working with the Stack Overflow databases</a>, if you're curious. Brent works for <a href="http://www.quest.com/">Quest Software</a> and he is, without a doubt, a <i>database ninja</i>. So if you have any difficult SQL Server problems -- or in our case, blazingly obvious newbie problems -- maybe you should check out Brent's <a href="http://sqlserverpedia.com/wiki ">SQL Server wiki</a>.</p>
<p>
While many queries are faster under SQL Server 2008, and the tooling is dramatically and indisputably better (intellisense for queries!), there is one downside for us: <b>SQL Server 2008 is slower at full-text search operations than SQL 2005</b>. That's kind of a bummer because we rely heavily on full text. I saw a glimpse of this in my initial testing, when I had both servers up side-by-side with the same data, running the same queries, to see how much faster it would be (new versions <i>are</i> supposed to be faster, right?). My experiments showed that any full-text queries I tried were inexplicably slower on 2008, but we thought it had to do with different query plans, and was something we could work around.</p>
<p>
Turns out we were wrong. Apparently SQL Server 2008 was the source of the massive slowdown earlier today. A set of full-text queries that <i>ran fine all last week on a single, shared server</i> caused a newly dedicated 8 CPU, 4 GB server to completely melt down and peg at 100%. Traffic levels were about the same, the database was about the same, and the code hasn't changed much. Not to mention the whole "newly dedicated database server", so you'd expect performance to be better, not worse.</p>
<p>
We're not the first people to notice that <a href="http://sqldev.wordpress.com/2008/09/16/sql-server-2008-full-text-slowness/">full text performance took a step backwards in SQL 2008</a>:</p>
<blockquote><p>
I was lucky enough to visit Microsoft during the CTP period and was testing out integrated full text search in 2008. An issue we experienced was that full text can be slow when there is a high number of updates to the index and is caused by blocking on the docidfilter internal table.
</p></blockquote>
<p>
That post mentions the <code>DBCC TRACEON (7646, -1)</code> flag. We've enabled this flag and restarted SQL Server, but haven't seen much improvement.</p>
<p>
The temporary workaround is much more aggressive caching, including caching to disk. Caching is the bread and butter of computer science, and any opportunity to cache smarter and.. er.. harder.. is a good thing. But all things considered, I'd still prefer it if SQL 2008 was delivering <i>better</i> full-text performance than 2005, not <i>worse</i>.</p>
<p /></p></p></p></p></p></p>
