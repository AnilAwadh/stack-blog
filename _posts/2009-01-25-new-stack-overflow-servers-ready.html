---
layout: post
title: New Stack Overflow Servers Ready
date: 2009-01-25 09:18:24.000000000 -05:00
categories:
- server
tags: []
status: publish
type: post
published: true
meta:
  _edit_last: '1'
  _podPressPostSpecific: a:6:{s:15:"itunes:subtitle";s:15:"##PostExcerpt##";s:14:"itunes:summary";s:15:"##PostExcerpt##";s:15:"itunes:keywords";s:17:"##WordPressCats##";s:13:"itunes:author";s:10:"##Global##";s:15:"itunes:explicit";s:2:"No";s:12:"itunes:block";s:2:"No";}
author:
  login: admin
  email: jatwood@codinghorror.com
  display_name: Jeff Atwood
  first_name: Jeff
  last_name: Atwood

---
<p>
After many trials and tribulations, the <a href="http://blog.stackoverflow.com/2009/01/new-stack-overflow-server-glamour-shots/">new Stack Overflow servers</a> are now ready to ship.</p>
<p>
<a href="http://blog.stackoverflow.com/2009/01/new-stack-overflow-server-glamour-shots/" style="border-bottom:none;"><img src="{{ site.baseurl }}/assets/stackoverflow-servers-shipping-ready.jpg" alt="stackoverflow-servers-shipping-ready" title="stackoverflow-servers-shipping-ready" border="0" /></a></p>
<p>
Ladies and gentlemen, meet the newest members of the stackoverflow.com hardware family: SOWEB1, SOWEB2, and SODB1. That's right, I even labelled them with my black and silver sharpies.</p>
<p>
It's been an awfully long month and a half since I originally asked <a href="http://blog.stackoverflow.com/2008/12/server-hosting-rent-vs-buy/">whether we should rent servers or buy them</a>. I've finished burn-in testing on all three servers and I am totally confident (barring any shipping disasters) they'll arrive at our hosting provider ready to slide into a rack and "just work". The benefit to you is that we <b>make stackoverflow.com even speedier than it already is, and <i>far</i> more scalable</b>.</p>
<p>
I learned quite a bit in building up these servers, and I certainly paid my dues in the process. So you'll forgive me if I took the liberty of personalizing our servers a little bit. </p>
<p>
<a href="http://blog.stackoverflow.com/2009/01/new-stack-overflow-server-glamour-shots/" style="border-bottom:none;"><img src="{{ site.baseurl }}/assets/stackoverflow-lenovo-rd120-shipping-ready.jpg" alt="stackoverflow-lenovo-rd120-shipping-ready" title="stackoverflow-lenovo-rd120-shipping-ready" border="0" /></a></p>
<p>
That's right, I build my servers with an extra-special ingredient: <b>love</b>. And <a href="http://www.codinghorror.com/blog/archives/000761.html">if loving these computers is wrong, I don't wanna be right</a>.</p>
<p>
I guess I was inspired by <a href="http://en.wikipedia.org/wiki/Amiga_1000">the old Amiga A1000 I used to own</a>, which had the signatures of the designers molded into the underside of the case.</p>
<p>
<a href="http://blog.stackoverflow.com/wp-content/uploads/amiga-a1000-signatures-large.jpg" style="border-bottom:none;"><img src="{{ site.baseurl }}/assets/amiga-a1000-signatures.jpg" alt="amiga-a1000-signatures" title="amiga-a1000-signatures" border="0" /></a></p>
<p>
Of course I'm just a schmuck who assembled some parts, and these guys were actual hardware design gurus far ahead of their time, but you know what I mean.</p>
<p>
In particular, I have to emphasize two things I learned. If you're building up servers, <b>make sure you do these two things as soon as they arrive:</b></p>
<ol>
<li>Update the BIOS and RAID firmware to the latest possible versions.
</li>
<li>Make sure you have the latest operating system drivers.
</li>
</ol>
<p>
I'm no stranger to BIOS updates and firmware flashes for my desktops and consumer hardware, but I was hesitant to mess with the firmware on a server. I figured if it ain't broke, don't fix it, that sort of thing. Well, I was wrong.</p>
<p>
The RD120 server demanded a BIOS flash as soon as I installed the slightly newer CPUs I ordered for it. No problem; that's fairly typical for newer CPUs. Done and done.</p>
<p>
What was much more unusual, however, was the way <b>RAID port #6 refused to operate on the server</b>. RAID ports #1 through #5 worked like a champ, but not #6. I ordered a grand total of 12 hard drives (6 + 2 + 2 + 2 spares), and I tried three of them in that port, to no avail. It would see the drive, then reject it within a few minutes. I figured this had to be a hardware problem so I called Lenovo. They dispatched a very friendly tech the next day who came out and replaced the RAID backplane. Unfortunately, this didn't fix the problem! After he troubleshot it for a bit, I got a lecture about using "non-Lenovo" industry standard SATA hard drives in a server. I actually have two official Lenovo 160 GB drives here, but he wouldn't use those either as they're not on the parts list for the RD120, somehow. I insisted, and we inserted the drive. To my amazement, this worked. I hadn't even considered putting in a different <i>brand</i> of drive. I thanked the tech, and after he left I tried another random SATA drive I have here. It too worked!</p>
<p>
(As an aside, I had a rip of a time finding the Windows app that shows you the status of / lets you control the RAID arrays, but I eventually dug it up -- the <a href="http://www-947.ibm.com/systems/support/supportsite.wss/docdisplay?lndocid=MIGR-61707&brandind=5000008">IBM ServeRAID application</a>. Thanks for nothing, Lenovo!)</p>
<p>
At this point I belatedly realized what my problem was. As soon as I got the RAID controller updated with the latest firmware, all my problems magically went away -- RAID port #6 started working perfectly with the original drives. I would have done this earlier, but Lenovo's update download didn't work for me, so I had to call support to get a pointer to the <a href="http://www-947.ibm.com/systems/support/supportsite.wss/docdisplay?brandind=5000008&lndocid=MIGR-5073646">IBM ServeRAID 8k series bootable ISO update</a>, which <i>did</i> work. (By the way, have you ever read anything scarier than <a href="ftp://ftp.software.ibm.com/systems/support/system_x/ibm_fw_aacraid_5.2.0-15421_anyos_32-64.chg">RAID controller bugfix change histories?</a> brrr. The latest patch was January 9th!) There were still some performance oddities until I updated the default (apparently very out of date) Windows Server 2008 driver to a newer version I downloaded from Lenovo's website.</p>
<p>
The moral of this story? See above. <b>Update the damn firmware and OS drivers to the very latest versions as soon as you get the servers, not weeks later!</b> You'll save yourself (and your vendor) a lot of hassle.</p>
<p>
I've done a fair bit of burn-in testing on all the servers, typical stuff like multiple instances of Prime95. but I paid special attention to the RD120 as it will be our database server. Brent Ozar, our <a href="http://www.brentozar.com/">friendly neighborhood DBA ninja</a>, recommended I configure the six-drive array thusly:</p>
<ul>
<li>Two drive RAID 1 mirror -- Operating System, SQL Server 2008, and Logfiles
</li>
<li>Four drive RAID 10 array -- Database files
</li>
</ul>
<p>
<img src="{{ site.baseurl }}/assets/so-db-config-serveraid-manager.png" alt="so-db-config-serveraid-manager" title="so-db-config-serveraid-manager" /></p>
<p>
I made it so, and I ran <a href="http://blogs.mssqltips.com/blogs/chadboyd/archive/2008/03/16/ssd-and-sql-sqlio-performance.aspx">some tests with SQLIO</a> to verify that the data file array had good performance characteristics. I created a 24 GB test file on the array, and used this syntax:</p>
<p><pre>
sqlio -k{R/W} -t8 -s120 -d{drive} -o16 -f{random/sequential} 
      -b{kilobytes} -BH -LS Testfile.dat
</pre>
<p>
That means 8 threads, for 120 seconds, hardware buffering only, 16 outstanding I/O operations per thread.</p>
<table width="450" cellpadding="2" cellspacing="2">
<tr>
<td>1kb sequential writes</td>
<td align="right">19.18 mb/sec</td>
<td align="right">6ms</td>
</tr>
<tr>
<td>8kb random reads</td>
<td align="right">26.90 mb/sec</td>
<td align="right">36ms</td>
</tr>
<tr>
<td>8kb random writes</td>
<td align="right">64.65 mb/sec</td>
<td align="right">15ms</td>
</tr>
<tr>
<td>64kb sequential reads</td>
<td align="right">344.77 mb/sec</td>
<td align="right">22ms</td>
</tr>
<tr>
<td>64kb sequential writes</td>
<td align="right">359.32 mb/sec</td>
<td align="right">21ms</td>
</tr>
<tr>
<td>128kb sequential reads</td>
<td align="right">395.40 mb/sec</td>
<td align="right">39ms</td>
</tr>
<tr>
<td>128kb sequential writes</td>
<td align="right">413.90 mb/sec</td>
<td align="right">38ms</td>
</tr>
<tr>
<td>256kb sequential reads</td>
<td align="right">464.85 mb/sec</td>
<td align="right">68ms</td>
</tr>
<tr>
<td>1mb sequential reads</td>
<td align="right">458.50 mb/sec</td>
<td align="right">278ms</td>
</tr>
</table>
<p>
This compares <i>very</i> favorably with the extremely expensive SAN configuration <a href="http://blogs.mssqltips.com/blogs/chadboyd/archive/2008/03/16/ssd-and-sql-sqlio-performance.aspx">Chad tested</a> (it's labelled Server #2 in his charts). <b>Behold the power of inexpensive SATA drives in a directly connected RAID 10 array!</b> It would have been even faster if had we gone with a six drive array, but we felt that the OS needed to be on a separate set of spindles.</p>
<p>
I also did a quick run of <a href="http://support.microsoft.com/kb/231619">SQLIOSim</a>, which completed fine but produced a few warnings about long IO requests -- but <a href="http://www.sqlteam.com/forums/topic.asp?TOPIC_ID=83710">apparently that's to be expected</a>.</p>
<blockquote><p>
<b>SQLIOSim will generate sufficient IO requests to overwhelm almost any disk subsystem.</b> The long IO message from the simulator are normal. Although this does tell you that at some point the disks won't keep up.
</p></blockquote>
<p>
As Joel pointed out on the last podcast, me personally building up these servers makes zero business sense if you factor in the cost of my time. But I've also learned a ton about these servers and the server industry in general in the process. Stuff I feel like I need to know to operate these servers responsibly while they live at a remote data center. To me, that's worth it -- I feel like I've paid myself to learn.</p>
<p>
So here's to you, SOWEB1, SOWEB2, and SODB1. Long may you run, you <i>magnificent bastards</i>.</p>
<p /></p></p></p></p></p></p></p></p></p></p></p></p></p></p></p>
